{% extends "base_menu.htm" %}
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
{% block head %}
<title>Mis Perfiles</title>
{% endblock %}
{% block contenido %}
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Eliminar Perfil</h4>
            </div>
            <div class="modal-body">
                <p> ¿Seguro que desea eliminar el test? </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" onclick="eliminar()" class="btn btn-danger">Sí, Deseo Eliminar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ModalAsignados" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Usuarios añadidos</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Buscar</label>
                        <input type="text" list="usuarios" class="form-control" oninput="complete()" id="inputBuscar">
                        <div class="alert alert-danger" id="usuarioNoExiste" role="alert">El usuario no existe</div>
                        <a onclick="aniadirAsignado()" class="btn btn-primary btn-sm aniadirAsignado"><span class="glyphicon glyphicon-plus"></span> Añadir</a>
                    </div>
                    <br></br>
                    <div class="form-group">
                        <h4 for="message-text" class="control-label">Añadidos</h4>
                        <div class="usuariosaniadidos" id="usuariosaniadidos">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>
<datalist id="usuarios">
</datalist>
<div id="contenido">
    <div id="menu_lateral">
        <div id="lista_izq">
            <ul id="milist">
                {% for test in tests %}
                <li>
                    <form id="listNombre" action="{% url 'cargarTest' %}" method="post">{% csrf_token %}
                        {% if test.id == mitest.id %}
                        <input class="listnameactive" type="submit" name="perfil" id="{{test.id|safe}}" value="{{test.nombre|safe}}"  ></input>
                        {% else %}
                        <input class="listname" type="submit" name="perfil" id="{{test.id|safe}}" value="{{test.nombre|safe}}"  ></input>
                        {% endif %}
                        <input id="soporte" type="hidden" name="testpulsado" value="{{test.id|safe}}"></input>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
        <form action="{% url 'nuevoTest' %}" method="post">{% csrf_token %}
            <button class="btn btn-primary " id="aniadirli" type="submit" onclick="aniadirli()">
                <span class="glyphicon glyphicon-plus"></span> Añadir Test</button>
            </form>
        </div>
        <div id="heuristica">
            <div role="tabpanel">

                <ul class="nav nav-tabs" role="tablist" id="myTab">
                    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Configuración</a></li>
                    <li role="presentation"><a href="#settings" onclick="cargarValoracion()" aria-controls="settings" role="tab" data-toggle="tab">Resultados</a></li>
                </ul>

                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="home">
                        <h5 class="headers">Titulo del Test </h5>
                        <input id="nombreDelTest" value="{{mitest.nombre}}"></input>
                        <h5 class="headers">Titulo del Juego </h5>
                        <input id="nombreDelJuego" value="{{mitest.titulo}}"></input>
                        <button class="btn btn-primary" onclick="abrirFormularioModal()"><span class="glyphicon glyphicon-plus"></span> Asignar Test</button>
                        <h4 class="headers">Seleccione las preguntas del Test </h4>
                        <div class="container-fluid">
                            <div class="navbar-header">
                                <a class="navbar-brand listajugabilidades marcada" id="Intrinseca" onclick="marcar(Intrinseca)">Intrínseca</a>
                                <a class="navbar-brand listajugabilidades" id="Mecanica" onclick="marcar(Mecanica)">Mecánica</a>
                                <a class="navbar-brand listajugabilidades" id="Interactiva" onclick="marcar(Interactiva)">Interáctiva</a>
                                <a class="navbar-brand listajugabilidades" id="Artistica" onclick="marcar(Artistica)">Artística</a>
                                <a class="navbar-brand listajugabilidades" id="Intrapersonal" onclick="marcar(Intrapersonal)">Intrapersonal</a>
                                <a class="navbar-brand listajugabilidades" id="Interpersonal" onclick="marcar(Interpersonal)">Interpersonal</a>
                            </div>
                        </div>
                        <div id="tablasHeuristicas">
                            <TABLE class="table table-striped table-hover " id="mitabla">
                                <TR>
                                    <TH>Seleccionada</TH> <TH>COD</TH> <TH>Heurística</TH>
                                </TR>
                                    <!--{% for dato in heuristicas %}
                                    <!-- <TR class="info" id="fila{{dato.id}}">
                                        <TD id="check"><input type="checkbox" id="{{ dato.id }}" name="option" checked onclick="seleccionar({{ dato.id }})"><br></TD>
                                        <TD id="dato{{dato.id}}"><b>{{ dato.id }}</b></TD>
                                        <TD ><p id="cuestion{{dato.id}}"><b>{{ dato.nombre }}</b></p></TD>
                                    </TR>
                                    {% endfor %} -->
                                    
                                </TABLE>
                            </div>
                            <button class="btn btn-primary botonesConfiguracion" onclick="guardarEnviar()"><span class="glyphicon glyphicon-send"></span> Guardar y Enviar Test</button>
                            <button class="btn btn-success botonesConfiguracion" onclick="guardar()"id="guardarConfiguracion"><span class="glyphicon glyphicon-floppy-disk"></span> Guardar</button>
                            <button class="btn btn-danger botonesConfiguracion" id="eliminarConfiguracion"><span class="glyphicon glyphicon-minus"></span> Eliminar Test</button>
                        </div>
                        
                        <div role="tabpanel" class="tab-pane" id="settings">
                            <nav class=" minavbar">
                                <div class="container-fluid">
                                    <div class="navbar-header">
                                        <a class="navbar-brand navbar-active cursor" id="menu_verValoracion" onclick="cargarValoracion()">Valoración</a>
                                        <a id="Resultados_verFacetas" onclick="verFacetas('Global')" class="navbar-brand cursor">Análisis Facetas</a>
                                        <a class="navbar-brand cursor" href="#">Análisis Atributos</a>
                                        <a class="navbar-brand cursor" href="#">Análisis Elementos</a>
                                        <a class="navbar-brand cursor" href="#">Respuesta</a>
                                        
                                    </div>
                                </div>
                            </nav>
                            <div id="contenidoMisTest">
                                <div class="oculta " id="maestro_detalle">
                                    <div id="listaResultados">
                                        <ul id="milistFacetas">
                                        </ul>
                                    </div>
                                    <div id="panel_resultados">
                                        <div id="grafIzq"></div>
                                        <div id="grafDer"></div>
                                    </div>
                                    <div id="panel_comentarios2">
                                        <h4 class="headers">Comentarios<h4>
                                            <textarea id="comentarios_resultados"></textarea>
                                    </div>
                                </div>
                                    <div class="" id="verValoración">
                                        <div id="tablaValoracion">
                                            <TABLE class="table table-striped " id="mitabla2">
                                                <TR>
                                                    <TH></TH><TH>Satisfacción</TH><TH>Aprendizaje</TH><TH>Eficiencia</TH><TH>Inmersión</TH><TH>Motivación</TH><TH>Emoción</TH><TH>Socialización</TH><TH>Media</TH>
                                                </TR>
                                                <TR class="">
                                                    <TH class="">J.Intrínseca</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>J.Mecánica</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>J.Interactiva</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>J.Artística</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>J.Personal</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>J.Social</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>
                                                <TR class="">
                                                    <TH>Media</TH>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                    <td class="row"></td>
                                                </TR>

                                            </TABLE>
                                        </div>
                                        <div id="panel_comentarios">
                                            <h4 class="headers">Comentarios<h4>
                                                <textarea id="comentarios_resultados"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <script>
                            $(function () {
                              $('#myTab a:first').tab('show')
                          })
                            </script>

                        </div>
                    </div>
                </div>
                <script>
                var seleccionados=[];
                var asignados=[];
                function aniadirli(){
                    var ul = document.getElementById("milist");
                    var li = document.createElement("li");
                    li.appendChild(document.createTextNode("Nuevo Test"));
                    ul.appendChild(li);
                }
                function marcar(id){
                    id.className = "navbar-brand listajugabilidades marcada";
                    if(id.id!="Intrinseca"){
                        document.getElementById("Intrinseca").className="navbar-brand listajugabilidades ";
                    }
                    if(id.id!="Mecanica"){
                        document.getElementById("Mecanica").className="navbar-brand listajugabilidades ";
                    }
                    if(id.id!="Interactiva"){
                        document.getElementById("Interactiva").className="navbar-brand listajugabilidades ";
                    }
                    if(id.id!="Artistica"){
                        document.getElementById("Artistica").className="navbar-brand listajugabilidades ";
                    }
                    if(id.id!="Intrapersonal"){
                        document.getElementById("Intrapersonal").className="navbar-brand listajugabilidades ";
                    }
                    if(id.id!="Interpersonal"){
                        document.getElementById("Interpersonal").className="navbar-brand listajugabilidades ";
                    }
                    $.post("{% url 'cargarTablas' %}",{id:id.id,csrfmiddlewaretoken:'{{csrf_token}}'},
                     function (result){
                         datos = JSON.parse(result.heuristica);


                         var table = document.getElementById('mitabla');
                         while(table.hasChildNodes()){
                             table.removeChild(table.firstChild);
                         }

                         var header = table.createTBody();
                         var row = header.insertRow(0);
                         table.className="table table-striped table-hover";

                         var cell = row.insertCell(0);
                         var cell1 = row.insertCell(1);
                         var cell2 = row.insertCell(2);

                         cell.innerHTML = "<b>Seleccionada</b>";
                         cell1.innerHTML = "<b>COD</b>";
                         cell2.innerHTML = "<b>Heurística</b>";

                         for (i in datos){
                             var table = document.getElementById('mitabla');



                             var row = table.insertRow(table.rows.length);
                             row.className="info";

                             var cell0 = row.insertCell(0);
                             var cell1 = row.insertCell(1);
                             var cell2 = row.insertCell(2);

                             if(seleccionados.lastIndexOf(datos[i].pk.toString())==-1){
                                cell0.innerHTML = '<td><input type="checkbox" id="'+datos[i].pk+'" onclick="seleccionar('+datos[i].pk+')" name="option"><br></td>';
                            }

                            else{
                                cell0.innerHTML = '<td><input type="checkbox" id="'+datos[i].pk+'" onclick="seleccionar('+datos[i].pk+')" name="option" checked><br></td>';
                            }

                            cell1.innerHTML = '<td><b>'+datos[i].pk+'</b></td>';
                            cell2.innerHTML = '<td><b>'+datos[i].fields.nombre+'</b></td>';
                        }
                    })

}

function guardar(){
    console.log(seleccionados);
    nombre = document.getElementById("nombreDelTest").value;
    titulo = document.getElementById("nombreDelJuego").value;
    $.post("{% url 'guardarTest' %}",{seleccionados:seleccionados,asignados:asignados,nombre:nombre,titulo:titulo,csrfmiddlewaretoken:'{{csrf_token}}'},
       function (result){
           document.getElementById("{{mitest.id}}").value=nombre;
       })
}

function abrirFormularioModal(){
    $('#ModalAsignados').modal('show')
}


function seleccionar(id){
    if(seleccionados.lastIndexOf(id.toString())==-1){
        seleccionados.push(id.toString())
    }
    else{
        seleccionados.splice(seleccionados.lastIndexOf(id),1);
    }
    console.log(seleccionados)
}

function cargarSeleccionados(){
    var aux = {{ mitest.seleccionados|safe }}
    if(aux){
        for(i in aux){
            aux2 = JSON.parse(aux[i])
            seleccionados.push(aux2[0].pk.toString());
        }
    }
    marcar(Intrinseca)
}

function cargarAsignados(){
    var aux = {{ mitest.asignados|safe }}
    if(aux){
        for(i in aux){
            asignados.push(aux[i]);
            options = '<br></br>'
            options+='<h4 class="asignado">'+aux[i]+'</h4>'
            options+='<a class="btn btn-danger btn-xs eliminarAsignados" onclick="eliminarAsignados(\''+aux[i]+'\')"><span class="glyphicon glyphicon-minus"></span> Eliminar</a>';
            options+='<a href="#" class="btn btn-primary btn-xs enviarAsignado" onclick="enviarAsignado(\''+aux[i]+'\')"><span class="glyphicon glyphicon-send"></span> Guardar y Enviar</a>'
            document.getElementById('usuariosaniadidos').innerHTML += options;
            console.log(aux[i].toString());
        }
    }
}

function eliminarAsignados(nombre){
    asignados.splice(asignados.lastIndexOf(nombre),1);
    document.getElementById('usuariosaniadidos').innerHTML ='<b></b>';
    for (i in asignados){
        options = '<br></br>'
        options+='<h4 class="asignado">'+asignados[i]+'</h4>'
        options+='<a class="btn btn-danger btn-xs eliminarAsignados" onclick="eliminarAsignados(\''+asignados[i]+'\')"><span class="glyphicon glyphicon-minus"></span> Eliminar</a>';
        options+='<a href="#" class="btn btn-primary btn-xs enviarAsignado" onclick="enviarAsignado(\''+asignados[i]+'\')"><span class="glyphicon glyphicon-send"></span> Guardar y Enviar</a>'
        document.getElementById('usuariosaniadidos').innerHTML += options;
    }
    console.log(asignados);
}

function complete(){
    if(document.getElementById("inputBuscar").value.length>=3){
        $.post("{% url 'cargarUsuarios' %}",{user:document.getElementById("inputBuscar").value,csrfmiddlewaretoken:'{{csrf_token}}'},
           function (result){
               list = result.usuarios
               options = ""
               for (i in list){
                   options += '<option value= "'+list[i]+'" />';
               }

               document.getElementById('usuarios').innerHTML = options;
           })

    }
}
function aniadirAsignado(){
    if(document.getElementById('inputBuscar').value.length!=0){
        $.post("{% url 'UsuarioExiste' %}",{user:document.getElementById("inputBuscar").value,csrfmiddlewaretoken:'{{csrf_token}}'},
           function (result){
               console.log(result.existe)
               if(result.existe){
                   options = '<br></br>'
                   options+='<h4 class="asignado">'+document.getElementById('inputBuscar').value+'</h4>'
                   options+='<a class="btn btn-danger btn-xs eliminarAsignados" onclick="eliminarAsignados(\''+document.getElementById('inputBuscar').value+'\')"><span class="glyphicon glyphicon-minus"></span> Eliminar</a>'
                   options+='<a href="#" class="btn btn-primary btn-xs enviarAsignado" onclick="enviarAsignado(\''+document.getElementById('inputBuscar').value+'\')"><span class="glyphicon glyphicon-send"></span> Guardar y Enviar</a>'
                   document.getElementById('usuariosaniadidos').innerHTML += options;
                   asignados.push(document.getElementById('inputBuscar').value);
                   console.log(asignados);
               }
               else{
                   document.getElementById("usuarioNoExiste").style.visibility = "visible";
                   timeoutID = window.setTimeout(function clerAlert() {
                     document.getElementById("usuarioNoExiste").style.visibility = "hidden";
                 }, 2000);
               }
           })

}
}

function enviarAsignado(nombre){
    aux = []
    aux.push(nombre)
    nombre2 = document.getElementById("nombreDelTest").value;
    titulo = document.getElementById("nombreDelJuego").value;
    console.log("Hola·")
    $.post("{% url 'guardarIndividual' %}",{seleccionados:seleccionados,asignados:asignados,envio:aux,nombre:nombre2,titulo:titulo,csrfmiddlewaretoken:'{{csrf_token}}'},
       function (result){
           document.getElementById("{{mitest.id}}").value=nombre2;
       })
}

function guardarEnviar(){
    nombre = document.getElementById("nombreDelTest").value;
    titulo = document.getElementById("nombreDelJuego").value;
    $.post("{% url 'guardarEnviar' %}",{seleccionados:seleccionados,asignados:asignados,nombre:nombre,titulo:titulo,csrfmiddlewaretoken:'{{csrf_token}}'},
       function (result){
           document.getElementById("{{mitest.id}}").value=nombre;

       })

}

/*Zona en la que cargo datos de los resultados obtenidos por los test resueltos por los usuarios a los que se le ha asignado*/
var resultados;
var datosparseados = []
function cargarDatos(){
    $.post("{% url 'cargarValoracion' %}",{csrfmiddlewaretoken:'{{csrf_token}}'},
        function (result){
            if(result.existe){
                resultados = JSON.parse(result.resultados)[0]
                parseoDatos();
            }

        })
}

/* Clase donde cargo los resultados de cada pregunta con sus atributos correspondinetes*/
function DatoParseado(jugabilidad,propiedad,atributo,nota,grado,elementos,rango){
    this.jugabilidad=jugabilidad
    this.propiedad=propiedad
    this.atributo=atributo
    this.nota=nota
    this.grado = grado
    this.elementos = elementos
    this.rango = rango
}
/* Array que contiene todos los elementos de un juego y sirve para poder hacer comprobaciones*/
TodosElementos = ["videogame", "desarrollo_de_personajes", "historia", "narrativa", "banda_sonora", "efectos_sonoros", "sonido_ambiental", "cardinalidad", "estetica", "realismo2", "control", "disposicion", "metaforas", "navegacion", "realimentacion", "aspecto_sonoro", "aspecto_visual", "interactividad", "cardinalidad2", "escala", "fronteras", "continuo", "libre", "variable", "ambiental", "emocional", "etica", "fisica", "temporal", "individual", "multijugador", "primarios", "secundarios", "implicitos", "explicitos", "esporadico", "a_ritmo_propio", "extrinsico", "intrinseco", "ritmo_externo", "aleatoriedad", "armonia", "contenido", "curva_de_aprendizaje", "dimensionalidad", "entidad", "equilibrio", "estado_de_progreso", "genero", "numero_de_jugadores", "realismo", "objetivos", "recompensas", "reglas", "retos", "ritmo", "segmentacion", "sistema_de_salvado", "tipo_de_contenido", "desarrollo_argumental", "experiencia_del_usuario", "mecanicas", "motor_fisico", "motor_grafico", "motor_de_ia", "motor_de_sonido", "sistema_de_comunicacion", "sistema_de_control_interactivo", "sistema_de_scripting", "interfaz_auditiva", "interfaz_tactil", "interfaz_visual", "interfaz_plataforma", "interfaz_de_usuario", "look_and_feel", "realimentacion2", "puntos_de_vista", "interfaz_fisica", "interfaz_software", "game_core", "game_engine", "game_interface"]

TodosAtributos = ["Satisfacción","Aprendizaje","Eficiencia","Inmersión","Motivación","Emoción","Socialización"]

/* Parseo los datos y los convierto en un array de objeto tipo DatoParseado*/
function parseoDatos(){
    misrespuestas = resultados.fields.respuestas
    misseleccionados = resultados.fields.seleccionados
    misrespuestas = JSON.parse(misrespuestas)
    misseleccionados = JSON.parse(misseleccionados)
    for (i in misrespuestas){
        for (j in misseleccionados){
            aux = JSON.parse(misseleccionados[j])
            if(misrespuestas[i].id==aux[0].pk){
                atributos = aux[0].fields.atributos
                atributos = JSON.parse(atributos)
                elementos = JSON.parse(aux[0].fields.elementos)
                if(atributos.length>0){
                    for(k in atributos){
                        rango = aux[0].fields.rango
                        jugabilidad = aux[0].fields.jugabilidad
                        auxAtributos = JSON.parse(atributos[k])
                        propiedad = auxAtributos.propiedad
                        grado = auxAtributos.grado
                        atributo=auxAtributos.atributo
                        nota=misrespuestas[i].value
                        datosparseados.push(new DatoParseado(jugabilidad,propiedad,atributo,nota,grado,elementos,rango))
                    }

                }
            }
        }
    }
    
}

/******************/
/* Función que carga y muestro los datos de la pestaña de Valoración para los resultados
*/
function cargarValoracion(){
    document.getElementById("menu_verValoracion").className="navbar-brand navbar-active cursor"
    document.getElementById("Resultados_verFacetas").className="navbar-brand  cursor"
    document.getElementById("verValoración").className=""
    document.getElementById("maestro_detalle").className="oculta"
    var contadores = [];
    for(var i=0; i<=6; i++) {
        contadores[i] = [];
        for(k in TodosAtributos) {
            contadores[i][k] = 0;
            contadores[i][k]=[];
            contadores[i][k][0]=0
            contadores[i][k][1]=0
        }
    }
    for( i in datosparseados){
        for (var j = 1; j <=6; j++) {
            for( k in TodosAtributos){
                if(datosparseados[i].jugabilidad==j.toString() && datosparseados[i].propiedad==TodosAtributos[k]){
                    contadores[j-1][k][1]++;
                    if(datosparseados[i].rango=="2"){
                        contadores[j-1][k][0]+=(datosparseados[i].nota*2)*(datosparseados[i].grado/100)
                    }
                    else{
                        contadores[j-1][k][0]+=(datosparseados[i].nota*1)*(datosparseados[i].grado/100)
                    }
                }
            }
        }
    }

    var table = document.getElementById("mitabla2");
    MediaAtributos=0
    MediaJugabilidad=0
    for (var i = 1; i< table.rows.length; i++) {
        row = table.rows[i]
        sumatoria = 0
        if(i<table.rows.length-1){
            for(var j=1; j<row.cells.length;j++){
                if(j<row.cells.length-1){
                    if(contadores[i-1][j-1][0]!=0){
                        sumatoria+=contadores[i-1][j-1][0]/contadores[i-1][j-1][1]
                        row.cells[j].innerHTML='<p>'+(contadores[i-1][j-1][0]/contadores[i-1][j-1][1]).toFixed(2)+'</p>'
                    }
                    else{
                        sumatoria+=0
                        row.cells[j].innerHTML='<p>'+0+'</p>'
                    }
                }
                else{
                    MediaJugabilidad+=sumatoria/7
                    row.cells[j].innerHTML='<p>'+(sumatoria/7).toFixed(2)+'</p>'
                }
            }
        }
        else{
            for(var k=0; k<7;k++){
                sumatoria2=0;
                for(var j=0; j<row.cells.length-2;j++){
                    if(contadores[j][k][0]!=0){
                        sumatoria2+=contadores[j][k][0]/contadores[j][k][1]
                    }
                    
                }
                MediaAtributos+=sumatoria2/6
                table.rows[j].cells[k+1].innerHTML='<p>'+(sumatoria2/6).toFixed(2)+'</p>'
            }
        }
    }
    if(MediaJugabilidad==0){
        total=0
    }
    else{
        total = (MediaAtributos/6) + (MediaJugabilidad/7)
    }
    table.rows[7].cells[8].innerHTML='<p>'+total.toFixed(2)+'</p>'
}

/*
Función que muestro los datos de los resultados por Facetas. Se hacen muchas comprobaciones para ver que elemento de la lista de Facetas se ha pulsado. Además se llama a las funciones de Gráficos para que muestre la información adecuada en cada momento
*/

function verFacetas(faceta){
    document.getElementById("menu_verValoracion").className="navbar-brand cursor"
    document.getElementById("Resultados_verFacetas").className="navbar-brand navbar-active cursor"
    document.getElementById("verValoración").className="oculta"
    document.getElementById("maestro_detalle").className=""

    options='<li>'
    if(faceta.toString()=='Global'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Global\')" type="submit" name="perfil"value="Global"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Global\')" type="submit" name="perfil"value="Global"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Intrínseca'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Intrínseca\')" type="submit" name="perfil"value="J.Intrínseca"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Intrínseca\')" type="submit" name="perfil"value="J.Intrínseca"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Mecánica'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Mecánica\')" type="submit" name="perfil"value="J.Mecánica"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Mecánica\')" type="submit" name="perfil"value="J.Mecánica"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Interactiva'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Interactiva\')" type="submit" name="perfil"value="J.Interactiva"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Interactiva\')" type="submit" name="perfil"value="J.Interactiva"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Artística'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Artística\')" type="submit" name="perfil"value="J.Artística"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Artística\')" type="submit" name="perfil"value="J.Artística"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Personal'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Personal\')" type="submit" name="perfil"value="J.Personal"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Personal\')" type="submit" name="perfil"value="J.Personal"></input>'
    }
    options+='<br></br>'
    if(faceta.toString()=='Social'){
        options+='<input class="listnameactive" onclick="verFacetas(\'Social\')" type="submit" name="perfil"value="J.Social"></input>'
    }
    else{
        options+='<input class="listname" onclick="verFacetas(\'Social\')" type="submit" name="perfil"value="J.Social"></input>'
    }
    options+='</li>'

    document.getElementById("milistFacetas").innerHTML=options

    var contadores = [];
    for(var i=0; i<=6; i++) {
        contadores[i] = [];
        for(k in TodosAtributos) {
            contadores[i][k] = 0;
            contadores[i][k]=[];
            contadores[i][k][0]=0
            contadores[i][k][1]=0
        }
    }
    for( i in datosparseados){
        for (var j = 1; j <=6; j++) {
            for( k in TodosAtributos){
                if(datosparseados[i].jugabilidad==j.toString() && datosparseados[i].propiedad==TodosAtributos[k]){
                    contadores[j-1][k][1]++;
                    if(datosparseados[i].rango=="2"){
                        contadores[j-1][k][0]+=(datosparseados[i].nota*2)*(datosparseados[i].grado/100)
                    }
                    else{
                        contadores[j-1][k][0]+=(datosparseados[i].nota*1)*(datosparseados[i].grado/100)
                    }
                }
            }
        }
    }

    basic_radar(contadores,faceta);
    basic_bars(contadores,faceta);
}

window.onload=cargarSeleccionados();
window.onload=cargarAsignados();
window.onload=cargarDatos();

/*
Funciones de gráficos para ver desde las Facetas
*/
function basic_radar(contadores,faceta) {
    // Fill series s1 and s2.
    

    datosAux = []

    if(faceta.toString()=='Global'){
        for (var j = 0; j <7; j++) {
            aux=0
            for( var i=0; i<contadores.length; i++){
                if(contadores[i][j][1]!=0){
                    aux += contadores[i][j][0]/contadores[i][j][1];
                }

            }
            datosAux.push(aux/6)
        }
    }
    else if(faceta.toString()=='Intrínseca'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[0][j][1]!=0){
                aux += contadores[0][j][0]/contadores[0][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Mecánica'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[1][j][1]!=0){
                aux += contadores[1][j][0]/contadores[1][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Interactiva'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[2][j][1]!=0){
                aux += contadores[2][j][0]/contadores[2][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Artística'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[3][j][1]!=0){
                aux += contadores[3][j][0]/contadores[3][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Personal'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[4][j][1]!=0){
                aux += contadores[4][j][0]/contadores[4][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Social'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[5][j][1]!=0){
                aux += contadores[5][j][0]/contadores[5][j][1];
            }
            datosAux.push(aux)
        }
    }

    var
    s1 = { label : 'Global', data : [[0, datosAux[0]], [1, datosAux[1]], [2, datosAux[2]], [3, datosAux[3]], [4, datosAux[4]], [5, datosAux[5]],[6, datosAux[6]]] },
    graph, ticks;

    // Radar Labels
    ticks = [
    [0, "Satisfacción"],
    [1, "Aprendizaje"],
    [2, "Eficiencia"],
    [3, "Inmersión"],
    [4, "Motivación"],
    [5, "Emoción"],
    [6, "Socialización"]
    ];

  // Draw the graph.
    graph = Flotr.draw(document.getElementById("grafIzq"), [ s1 ], {
        radar : { show : true}, 
        grid  : { circular : true, minorHorizontalLines : true}, 
        yaxis : { min : 0, max : 10, minorTickFreq : 2}, 
        xaxis : { ticks : ticks}});
}

function basic_bars(contadores,faceta,horizontal) {

    datosAux = []

    if(faceta.toString()=='Global'){
        for (var j = 0; j <7; j++) {
            aux=0
            for( var i=0; i<contadores.length; i++){
                if(contadores[i][j][1]!=0){
                    aux += contadores[i][j][0]/contadores[i][j][1];
                }

            }
            datosAux.push(aux/6)
        }
    }
    else if(faceta.toString()=='Intrínseca'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[0][j][1]!=0){
                aux += contadores[0][j][0]/contadores[0][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Mecánica'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[1][j][1]!=0){
                aux += contadores[1][j][0]/contadores[1][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Interactiva'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[2][j][1]!=0){
                aux += contadores[2][j][0]/contadores[2][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Artística'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[3][j][1]!=0){
                aux += contadores[3][j][0]/contadores[3][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Personal'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[4][j][1]!=0){
                aux += contadores[4][j][0]/contadores[4][j][1];
            }
            datosAux.push(aux)
        }
    }
    else if(faceta.toString()=='Social'){
        for (var j = 0; j <7; j++) {
            aux=0
            if(contadores[5][j][1]!=0){
                aux += contadores[5][j][0]/contadores[5][j][1];
            }
            datosAux.push(aux)
        }
    }

    var
    d1 = [[0, datosAux[0]], [1, datosAux[1]], [2, datosAux[2]], [3, datosAux[3]], [4, datosAux[4]], [5, datosAux[5]],[6, datosAux[6]]], 
    point,                                    // Data point variable declaration
    i;

    ticks = [
    [0, "Satisfacción"],
    [1, "Aprendizaje"],
    [2, "Eficiencia"],
    [3, "Inmersión"],
    [4, "Motivación"],
    [5, "Emoción"],
    [6, "Socialización"]
    ];


  // Draw the graph
  Flotr.draw(
    document.getElementById("grafDer"),
    [d1],
    {
      bars : {
        show : true,
        horizontal : horizontal,
        shadowSize : 0,
        barWidth : 0.5
    },
    mouse : {
        track : true,
        relative : true
    },
    yaxis : {
        min : 0,
        autoscaleMargin : 1
    },
    xaxis : { ticks : ticks}
}
);
}

/*
Funciones para mostrar los datos desde la vista de Atributos
*/
</script>
{% endblock %}
</html>